<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR –°–∫–∞–Ω–µ—Ä | QR Master Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .btn {
            background: linear-gradient(135deg, #FF6B6B, #EE5A24);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
            transition: transform 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin: 15px 0;
            border-radius: 12px;
            overflow: hidden;
            display: none;
            background: #000;
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #FF6B6B;
            border-radius: 12px;
            pointer-events: none;
        }
        
        .scan-line {
            position: absolute;
            height: 2px;
            width: 100%;
            background: #FF6B6B;
            top: 0;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        #result {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            display: none;
        }
        
        .status {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            min-height: 20px;
        }
        
        .error {
            background: rgba(255,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ QR –°–∫–∞–Ω–µ—Ä</h1>
            <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</p>
        </div>
        
        <div class="status" id="status">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É"</div>
        
        <button class="btn" id="startBtn" onclick="startCamera()">
            üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
        </button>
        
        <button class="btn btn-secondary" onclick="closeApp()">
            ‚Ü©Ô∏è –ù–∞–∑–∞–¥
        </button>
        
        <div class="error" id="error"></div>
        
        <div class="video-container" id="videoContainer">
            <video id="video" playsinline></video>
            <div class="scan-overlay">
                <div class="scan-line"></div>
            </div>
        </div>
        
        <div id="result"></div>
        
        <canvas id="canvas" style="display: none;"></canvas>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const videoContainer = document.getElementById('videoContainer');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const result = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        
        let stream = null;
        let isScanning = false;
        let animationFrame = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            status.textContent = '–û—à–∏–±–∫–∞';
        }
        
        function hideError() {
            errorDiv.style.display = 'none';
        }
        
        function setStatus(message) {
            status.textContent = message;
        }
        
        async function startCamera() {
            try {
                setStatus('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');
                hideError();
                startBtn.disabled = true;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã
                const constraints = {
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // –ñ–¥–µ–º –ø–æ–∫–∞ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
                video.onloadeddata = () => {
                    videoContainer.style.display = 'block';
                    setStatus('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥...');
                    startScanning();
                };
                
                video.onerror = () => {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
                    startBtn.disabled = false;
                };
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ
                await video.play();
                
            } catch (error) {
                startBtn.disabled = false;
                handleCameraError(error);
            }
        }
        
        function handleCameraError(error) {
            console.error('Camera error:', error);
            
            if (error.name === 'NotAllowedError') {
                showError('‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
            } else if (error.name === 'NotFoundError') {
                showError('‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.');
            } else if (error.name === 'NotSupportedError') {
                showError('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.');
            } else if (error.name === 'NotReadableError') {
                showError('‚ùå –ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.');
            } else {
                showError('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message);
            }
            
            setStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
        }
        
        function startScanning() {
            if (isScanning) return;
            
            isScanning = true;
            scanFrame();
        }
        
        function stopScanning() {
            isScanning = false;
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        }
        
        function scanFrame() {
            if (!isScanning) return;
            
            try {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // –†–∏—Å—É–µ–º –∫–∞–¥—Ä –Ω–∞ canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR-–∫–æ–¥
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        handleQRDetected(code.data);
                        return;
                    }
                }
                
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                animationFrame = requestAnimationFrame(scanFrame);
                
            } catch (error) {
                console.error('Scan error:', error);
                stopScanning();
                showError('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
            }
        }
        
        function handleQRDetected(data) {
            stopScanning();
            
            result.innerHTML = `
                <h3>‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!</h3>
                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; word-break: break-all;">
                    <strong>–î–∞–Ω–Ω—ã–µ:</strong><br>
                    ${escapeHtml(data)}
                </div>
                <button class="btn" onclick="restartScanner()">üîÑ –°–∫–∞–Ω–∏—Ç—å –µ—â–µ</button>
            `;
            result.style.display = 'block';
            
            setStatus('QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
            try {
                Telegram.WebApp.sendData(data);
            } catch (error) {
                console.error('Error sending to Telegram:', error);
            }
        }
        
        function restartScanner() {
            result.style.display = 'none';
            setStatus('–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é');
            startScanning();
        }
        
        function closeApp() {
            stopScanning();
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            Telegram.WebApp.close();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            stopScanning();
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
